name: citra-mts
version: git
confinement: strict
base: core18
grade: stable
#icon: https://github.com/citra-emu/citra/raw/master/dist/icon.png

architectures:
  - build-on: amd64

summary: Nintendo 3DS Emulator
description: |
  Citra is a work-in-progress Nintendo 3DS emulator started in early 2014.
  Citra can currently emulate, with varying degrees of success, a wide variety of different homebrew applications and commercial software.

parts:

  ffmpeg:
    plugin: nil
    build-packages: [libfdk-aac-dev, ffmpeg, libswscale-dev, libavformat-dev, libavcodec-dev, libavdevice-dev, libavcodec-extra]
    stage-packages: [libfdk-aac1, ffmpeg, libswscale5, libavdevice58, libavformat58, libavcodec58, libavcodec-extra]

  prepare:
    plugin: nil
    build-packages: [pkg-config, dpkg-dev, build-essential, libsdl2-dev, qtbase5-dev, libqt5opengl5-dev, qtmultimedia5-dev, libqt5x11extras5-dev]
    stage-packages: [qtwayland5, sdl2, qtbase5-dev, libqt5opengl5, qtmultimedia5, libpulse0, libqt5multimedia5-plugins, libqt5x11extras5, libfdk-aac1]
  
  citra-canary:
    plugin: cmake
    source: https://github.com/citra-emu/citra-canary.git
    #source-tag: canary-1345
    configflags: [-DCMAKE_BUILD_TYPE=Release, -DCMAKE_INSTALL_PREFIX=/canary, -DENABLE_FFMPEG_AUDIO_DECODER=ON]
    override-build: |
      snapcraftctl build
      sed -i 's|Icon=citra|Icon=${SNAP}/canary/share/icons/hicolor/scalable/apps/citra.svg|' ${SNAPCRAFT_PART_INSTALL}/canary/share/applications/citra.desktop
      sed -i 's|Name=Citra|Name=Citra-MTS-Canary|' ${SNAPCRAFT_PART_INSTALL}/canary/share/applications/citra.desktop
      sed -i 's|TryExec=citra-qt|TryExec=$SANP/bin/citra-qt|' ${SNAPCRAFT_PART_INSTALL}/canary/share/applications/citra.desktop
    after: [prepare, ffmpeg]
  
  citra-nightly:
    plugin: cmake
    source: https://github.com/citra-emu/citra-nightly.git
    configflags: [-DCMAKE_BUILD_TYPE=Release, -DCMAKE_INSTALL_PREFIX=/nightly, -DENABLE_FFMPEG_AUDIO_DECODER=ON]
    override-build: |
      snapcraftctl build
      sed -i 's|Icon=citra|Icon=${SNAP}/nightly/share/icons/hicolor/scalable/apps/citra.svg|' ${SNAPCRAFT_PART_INSTALL}/nightly/share/applications/citra.desktop
      sed -i 's|Name=Citra|Name=Citra-MTS-Nightly|' ${SNAPCRAFT_PART_INSTALL}/nightly/share/applications/citra.desktop
      sed -i 's|TryExec=citra-qt|TryExec=$SANP/bin/citra-qt|' ${SNAPCRAFT_PART_INSTALL}/nightly/share/applications/citra.desktop
    after: [prepare, ffmpeg]
    
apps:

  citra-canary:
    command: $SNAP/canary/bin/citra-qt
    desktop: canary/share/applications/citra.desktop
    extensions: [gnome-3-34]
    environment:
      DISABLE_WAYLAND: 1 # Fallback to XWayland if running in a Wayland session. probably missing something to enable wayland...
      QT_DEBUG_PLUGINS: 1

  citra-nightly:
    command: $SNAP/nightly/bin/citra-qt
    desktop: nightly/share/applications/citra.desktop
    extensions: [gnome-3-34]
    environment:
      DISABLE_WAYLAND: 1 # Fallback to XWayland if running in a Wayland session. probably missing something to enable wayland...
      QT_DEBUG_PLUGINS: 1
